cscope 15 $HOME/project/sigmod2017/sigmod17 -q 0000000129 0000008479
	@include/thread_struct.h

1 #´agm¨
Úû


2 
	~<io¡»am
>

3 
	#MAX_BATCH_SIZE
 1000

	)

5 
	sO³¿tiÚ
{

6 
	mcmd
;

7 
	m¡d
::
¡ršg
 
¡r
;

9 
	sThrArg
{

10 
	mh—d
;

11 
	m
;

12 
O³¿tiÚ
 
	mİ”©iÚs
[
MAX_BATCH_SIZE
];

13 
	mtid
;

	@include/trie.h

1 #´agm¨
Úû


2 
	~<io¡»am
>

3 
	~<m­
>

5 
	~<veùÜ
>

7 
	gTr›Node
;

8 
	g¡d
::
	tm­
<, 
	tTr›Node
*> 
	tTr›M­
;

10 
	sTr›Node
{

11 
	mts
;

12 
	mút
;

13 
Tr›M­
 
	mÃxt
;

16 
	g¡d
::
	t·œ
<
	t¡d
::
	t¡ršg
, 
	tTr›Node
*> 
	tÿnd_t
;

17 
	#MY_TS
(
tid
è(((
ts
è<< 6è| (
NUM_THREAD
-tid))

	)

19 
	#USE_CALLOC


	)

21 #ifdeà
USE_CALLOC


22 
	#ÃwTr›Node
(
x
) do{\

23 (
x
èğ(
Tr›Node
*è
	`ÿÎoc
(1, (TrieNode));\

24 (
x
)->
Ãxt
.
	`ş—r
();\

25 }0)

	)

26 
	#ä“Tr›Node
(
x
è
	`ä“
(x)

	)

28 
	#ÃwTr›Node
(
x
) do{\

29 (
x
èğ
Ãw
 
Tr›Node
;\

30 (
x
)->
út
 = 0;\

31 }0)

	)

32 
	#ä“Tr›Node
(
x
è
	`d–‘e
 (x)

	)

35 
š™Tr›
(
Tr›Node
** 
node
);

36 
de¡royTr›
(
Tr›Node
* 
node
);

38 
addNg¿m
(
Tr›Node
* 
node
, 
¡d
::
¡ršg
 cÚ¡ &
ng¿m
);

39 
d–Ng¿m
(
Tr›Node
* 
node
, 
¡d
::
¡ršg
 cÚ¡ &
ng¿m
);

40 
qu”yNg¿m
(
¡d
::
veùÜ
<
ÿnd_t
> *
ÿnds
, 
my_ts
, 
Tr›Node
* 
Œ›
, cÚ¡ *
qu”y
);

	@src/main.cc

1 
	~<io¡»am
>

2 
	~<¡ršg.h
>

3 
	~<veùÜ
>

4 
	~<unÜd”ed_£t
>

5 
	~<as£¹.h
>

6 
	~<±h»ad.h
>

7 
	~<uni¡d.h
>

8 
	~"Œ›.h
"

9 
	~"th»ad_¡ruù.h
"

11 
	#NUM_THREAD
 39

	)

12 
	#my_hash
(
x
è((()(x))%
NUM_THREAD
)

	)

14 
	#USE_YIELD


	)

16 #ifdeà
USE_YIELD


17 
	#my_y›ld
(è
	`±h»ad_y›ld
()

	)

19 
	#my_y›ld
(è
	`u¦“p
(1)

	)

22 
	#FLAG_NONE
 0

	)

23 
	#FLAG_QUERY
 1

	)

24 
	#FLAG_END
 2

	)

26 
Tr›Node
 *
	gŒ›
[
NUM_THREAD
];

27 
±h»ad_t
 
	gth»ads
[
NUM_THREAD
];

28 
ThrArg
 
	g¬gs
[
NUM_THREAD
];

30 
	gts
;

32 
	gglob®_æag
;

33 
	g¡¬‹d
[
NUM_THREAD
][16];

34 
	gfšished
[
NUM_THREAD
][16];

35 
	g¡d
::
veùÜ
<
ÿnd_t
> 
»s
[
NUM_THREAD
];

36 cÚ¡ *
	gqu”y_¡r
;

37 
	gsize_qu”y
;

39 *
	$th»ad_maš
(*
¬g
){

40 
ThrArg
 *
myqueue
 = (ThrArg*)
¬g
;

41 
tid
 = 
myqueue
->tid;

42 
Tr›Node
 *
my_Œ›
 = 
Œ›
[
tid
];

43 
¡d
::
veùÜ
<
ÿnd_t
> *
my_»s
 = &
»s
[
tid
];

44 
O³¿tiÚ
 *
İ
;

46 
myqueue
->
h—d
 =ğmyqueue->

){

47 ià(
glob®_æag
 =ğ
FLAG_NONE
){

48 
	`my_y›ld
();

51 ià(
glob®_æag
 =ğ
FLAG_QUERY
){

52 ià(
¡¬‹d
[
tid
][0] =ğ
ts
){

53 
	`my_y›ld
();

56 
	`__sync_synchrÚize
();

57 ià(
myqueue
->
h—d
 !ğmyqueue->

) ;

58 
	`__sync_synchrÚize
();

59 
size
 = 1 + (
size_qu”y
-1è/ 
NUM_THREAD
;

60 cÚ¡ *
¡¬t
 = 
qu”y_¡r
 + 
size
 * 
tid
;

61 cÚ¡ *
’d
 = 
¡¬t
 + 
size
;

62 ià(
’d
-
qu”y_¡r
 > 
size_qu”y
)

63 
’d
 = 
qu”y_¡r
 + 
size_qu”y
;

64 
myqueue
->
h—d
 = myqueue->

 = 0;

65 
¡¬‹d
[
tid
][0] = 
ts
;

66 
my_»s
->
	`ş—r
();

67 
	`__sync_synchrÚize
();

68 cÚ¡ *
c
 = 
¡¬t
; c < 
’d
; c++){

69 ià(*
c
 == ' ')

70 
c
++;

72 
c
 !ğ
’d
 && *(c-1) != ' ') c++;

73 ià(
c
 =ğ
’d
)

75 
hv®
 = 
	`my_hash
(*
c
);

76 
¡¬‹d
[
hv®
][0] !ğ
ts
)

77 
	`my_y›ld
();

78 
	`qu”yNg¿m
(
my_»s
, 
	`MY_TS
(
tid
), 
Œ›
[
hv®
], 
c
);

80 
	`__sync_synchrÚize
();

81 
fšished
[
tid
][0] = 
ts
;

84 
	`±h»ad_ex™
((*)
NULL
);

86 
İ
 = &(
myqueue
->
İ”©iÚs
[myqueue->
h—d
++]);

87 ià(
İ
->
cmd
 == 'A')

88 
	`addNg¿m
(
my_Œ›
, 
İ
->
¡r
);

90 
	`d–Ng¿m
(
my_Œ›
, 
İ
->
¡r
);

92 
	`±h»ad_ex™
((*)
NULL
);

93 
	}
}

95 
	$š™Th»ad
(){

96 
i
 = 0; i < 
NUM_THREAD
; i++){

97 
¬gs
[
i
].
tid
 = i;

98 
	`±h»ad_ü—‹
(&
th»ads
[
i
], 
NULL
, &
th»ad_maš
, (*)&
¬gs
[i]);

100 
	}
}

101 
	$de¡royTh»ad
(){

102 
i
 = 0; i < 
NUM_THREAD
; i++)

103 
	`±h»ad_još
(
th»ads
[
i
], 
NULL
);

104 
	}
}

106 
	$šput
(){

107 
¡d
::
¡ršg
 
buf
;

109 
¡d
::
	`g‘lše
(¡d::
cš
, 
buf
);

110 ià(
buf
.
	`com·»
("S") == 0)

113 
	`addNg¿m
(
Œ›
[
	`my_hash
(*
buf
.
	`begš
())], buf);

115 
	}
}

117 
	$wÜklßd
(){

118 
¡d
::
¡ršg
 
cmd
;

119 
¡d
::
¡ršg
 
buf
;

120 
	`´štf
("R\n");

121 
	`fæush
(
¡dout
);

122 !
¡d
::
cš
.
	`eof
()){

123 
¡d
::
cš
 >> 
cmd
;

124 ià(
cmd
.
	`com·»
("F") == 0){

125 
	`fæush
(
¡dout
);

126 
¡d
::
cš
 >> 
cmd
;

127 ià(
cmd
.
	`com·»
("F") == 0){

128 
glob®_æag
 = 
FLAG_END
;

132 
¡d
::
	`g‘lše
(¡d::
cš
, 
buf
);

133 ià(
cmd
.
	`com·»
("Q") != 0){

134 
buf
.
	`”a£
(buf.
	`begš
());

135 
ThrArg
 *
wÜk”
 = &
¬gs
[
	`my_hash
(*
buf
.
	`begš
())];

136 
wÜk”
->
İ”©iÚs
[wÜk”->

].
cmd
 = *(cmd.
	`begš
());

137 
wÜk”
->
İ”©iÚs
[wÜk”->

].
¡r
 = 
buf
;

138 
	`__sync_synchrÚize
();

139 
wÜk”
->

++;

142 
ts
++;

143 #ifdeà
DBG_TS


144 
¡d
::
cout
 << 
ts
 << " ";

146 
qu”y_¡r
 = 
buf
.
	`c_¡r
();

147 
size_qu”y
 = 
buf
.
	`size
();

148 
	`__sync_synchrÚize
();

149 
glob®_æag
 = 
FLAG_QUERY
;

150 
	`__sync_synchrÚize
();

151 
boŞ
 
´št_ªsw”
 = 
çl£
;

152 
i
 = 0; i < 
NUM_THREAD
; i++){

153 
fšished
[
i
][0] !ğ
ts
è
	`my_y›ld
();

154 
my_ts
 = 
	`MY_TS
(
i
);

155 
¡d
::
veùÜ
<
ÿnd_t
>::
cÚ¡_™”©Ü
 
™
 = 
»s
[
i
].
	`begš
(); iˆ!ğ»s[i].
	`’d
(); it++){

156 ià(
™
->
£cÚd
->
ts
 =ğ
my_ts
){

157 ià(
´št_ªsw”
)

158 
¡d
::
cout
 << "|";

159 
´št_ªsw”
 = 
Œue
;

160 
¡d
::
cout
 << 
™
->
fœ¡
;

164 ià(!
´št_ªsw”
)

165 
¡d
::
cout
 << -1;

166 
¡d
::
cout
 << std::
’dl
;

167 
glob®_æag
 = 
FLAG_NONE
;

170 
	}
}

172 
	$maš
(
¬gc
, *
¬gv
[]){

173 
¡d
::
ios
::
	`sync_w™h_¡dio
(
çl£
);

174 
i
 = 0; i < 
NUM_THREAD
; i++)

175 
	`š™Tr›
(&
Œ›
[
i
]);

176 #ifdeà
DBG_LOG


177 
¡d
::
û¼
<<"š™T»dÚe" << std::
’dl
;

179 
	`š™Th»ad
();

180 #ifdeà
DBG_LOG


181 
¡d
::
û¼
<<"š™Th»ad dÚe" << std::
’dl
;

183 
	`šput
();

184 #ifdeà
DBG_LOG


185 
¡d
::
û¼
<<"špuˆdÚe" << std::
’dl
;

187 
	`wÜklßd
();

188 #ifdeà
DBG_LOG


189 
¡d
::
û¼
<<"wÜklßd dÚe" << std::
’dl
;

191 
	`de¡royTh»ad
();

192 #ifdeà
DBG_LOG


193 
¡d
::
û¼
<<"de¡royTh»ad dÚe" << std::
’dl
;

195 
i
 = 0; i < 
NUM_THREAD
; i++)

196 
	`de¡royTr›
(
Œ›
[
i
]);

197 #ifdeà
DBG_LOG


198 
¡d
::
û¼
<<"de¡royTr› dÚe" << std::
’dl
;

201 
	}
}

	@src/trie.cc

1 
	~"Œ›.h
"

2 
	~<io¡»am
>

3 
	~<as£¹.h
>

4 
	~<veùÜ
>

5 
	~<jem®loc/jem®loc.h
>

7 
	$š™Tr›
(
Tr›Node
** 
node
){

8 
	`ÃwTr›Node
(*
node
);

9 
	}
}

11 
	$de¡royTr›
(
Tr›Node
* 
node
){

12 
Tr›M­
::
™”©Ü
 
™
 = 
node
->
Ãxt
.
	`begš
(); iˆ!ğnode->Ãxt.
	`’d
(); it++){

13 
	`de¡royTr›
(
™
->
£cÚd
);

15 
	`ä“Tr›Node
(
node
);

16 
	}
}

18 
	$addNg¿m
(
Tr›Node
* 
node
, 
¡d
::
¡ršg
 cÚ¡& 
ng¿m
){

19 
Tr›M­
::
™”©Ü
 
‹mp
;

20 
Tr›Node
 *
ÃwNode
;

21 
¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
™
 = 
ng¿m
.
	`begš
(); iˆ!ğng¿m.
	`’d
(); it++){

22 
	`as£¹
(
node
 !ğ
NULL
);

23 
node
->
út
++;

24 
‹mp
 = 
node
->
Ãxt
.
	`fšd
(*
™
);

25 ià(
‹mp
 =ğ
node
->
Ãxt
.
	`’d
()){

26 
	`ÃwTr›Node
(
ÃwNode
);

27 
ÃwNode
->
ts
 = 0xFFFFFFFF;

28 
node
->
Ãxt
[*
™
] = 
ÃwNode
;

29 
node
 = 
ÃwNode
;

32 
node
 = 
‹mp
->
£cÚd
;

34 
node
->
út
++;

35 
node
->
ts
 = 1;

36 
	}
}

38 
	$d–Ng¿m
(
Tr›Node
 *
node
, 
¡d
::
¡ršg
 cÚ¡& 
ng¿m
){

39 
Tr›M­
::
™”©Ü
 
‹mp
;

40 
Tr›Node
 *
Ãxt
;

41 
¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
™
;

43 ià(
ng¿m
.
	`begš
(è=ğng¿m.
	`’d
()){

44 
node
->
út
--;

45 
node
->
ts
 = 0xFFFFFFFF;

49 
™
 = 
ng¿m
.
	`begš
(); iˆ!ğng¿m.
	`’d
(); it++){

50 
node
->
út
--;

51 
	`as£¹
(
node
->
út
 > 0);

52 
‹mp
 = 
node
->
Ãxt
.
	`fšd
(*
™
);

53 
	`as£¹
(
‹mp
 !ğ
node
->
Ãxt
.
	`’d
());

54 
Ãxt
 = 
‹mp
->
£cÚd
;

55 ià(
Ãxt
->
út
 == 1){

56 
node
->
Ãxt
.
	`”a£
(
‹mp
);

57 
node
 = 
Ãxt
;

60 
node
 = 
Ãxt
;

62 ià(
™
 =ğ
ng¿m
.
	`’d
()){

63 
node
->
út
--;

64 
node
->
ts
 = 0xFFFFFFFF;

67 ++
™
; iˆ!ğ
ng¿m
.
	`’d
(); it++){

68 
Ãxt
 = 
node
->Ãxt.
	`begš
()->
£cÚd
;

69 
	`ä“Tr›Node
(
node
);

70 
node
 = 
Ãxt
;

72 
	`ä“Tr›Node
(
node
);

73 
	}
}

75 
qu”yNg¿m
(
¡d
::
veùÜ
<
ÿnd_t
> *
ÿnds
, 
my_ts
, 
Tr›Node
* 
node
, cÚ¡ *
qu”y
){

76 
	g¡d
::
¡ršg
 
buf
;

77 
	gTr›M­
::
™”©Ü
 
‹mp
;

78 
	gnode_ts
;

79 cÚ¡ * 
	g™
 = 
qu”y
; *it != 0; it++){

80 
	gnode_ts
 = 
node
->
ts
;

81 
	gnode_ts
 < 
	gmy_ts
 && *
	g™
 == ' '){

82 ià(
__sync_boŞ_com·»_ªd_sw­
(&
node
->
ts
, 
node_ts
, 
my_ts
)){

83 
ÿnds
->
em¶aû_back
(
make_·œ
(
buf
, 
node
));

86 
	gnode_ts
 = 
node
->
ts
;

88 
	gbuf
 +ğ*
™
;

89 
	g‹mp
 = 
node
->
Ãxt
.
fšd
(*
™
);

90 ià(
	g‹mp
 =ğ
node
->
Ãxt
.
’d
())

92 
	gnode
 = 
‹mp
->
£cÚd
;

94 
	gnode_ts
 = 
node
->
ts
;

95 
	gnode_ts
 < 
	gmy_ts
){

96 ià(
__sync_boŞ_com·»_ªd_sw­
(&
node
->
ts
, 
node_ts
, 
my_ts
)){

97 
	gÿnds
->
em¶aû_back
(
make_·œ
(
buf
, 
node
));

100 
	gnode_ts
 = 
node
->
ts
;

	@
1
.
0
4
63
include/thread_struct.h
include/trie.h
src/main.cc
src/trie.cc
